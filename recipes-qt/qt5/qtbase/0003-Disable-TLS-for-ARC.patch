From ec444c121593095778646057835af0f2117ba5db Mon Sep 17 00:00:00 2001
From: Evgeniy Didin <Evgeniy.Didin@synopsys.com>
Date: Fri, 26 Oct 2018 15:05:16 +0300
Subject: [PATCH] Disable TLS for ARC due to toolchain issues

Signed-off-by: Evgeniy Didin <Evgeniy.Didin@synopsys.com>
---
 src/corelib/global/qcompilerdetection.h |  6 ------
 src/corelib/thread/qthread_unix.cpp     | 12 ------------
 2 files changed, 18 deletions(-)

diff --git a/src/corelib/global/qcompilerdetection.h b/src/corelib/global/qcompilerdetection.h
index 231ac2c..48f082c 100644
--- a/src/corelib/global/qcompilerdetection.h
+++ b/src/corelib/global/qcompilerdetection.h
@@ -394,7 +394,6 @@
 #        define Q_COMPILER_RVALUE_REFS
 #        define Q_COMPILER_STATIC_ASSERT
 #        define Q_COMPILER_TEMPLATE_ALIAS
-#        define Q_COMPILER_THREAD_LOCAL
 #        define Q_COMPILER_THREADSAFE_STATICS
 #        define Q_COMPILER_UDL
 #        define Q_COMPILER_UNICODE_STRINGS
@@ -545,7 +544,6 @@
  *  N2118 N2844 N3053 Q_COMPILER_RVALUE_REFS            __cpp_rvalue_references = 200610
  *  N1720           Q_COMPILER_STATIC_ASSERT            __cpp_static_assert = 200410
  *  N2258           Q_COMPILER_TEMPLATE_ALIAS
- *  N2659           Q_COMPILER_THREAD_LOCAL
  *  N2660           Q_COMPILER_THREADSAFE_STATICS
  *  N2765           Q_COMPILER_UDL                      __cpp_user_defined_literals = 200809
  *  N2442           Q_COMPILER_UNICODE_STRINGS          __cpp_unicode_literals = 200710
@@ -632,7 +630,6 @@
 #      define Q_COMPILER_ALIGNAS
 #      define Q_COMPILER_ALIGNOF
 #      define Q_COMPILER_INHERITING_CONSTRUCTORS
-#      define Q_COMPILER_THREAD_LOCAL
 #      define Q_COMPILER_UDL
 #    endif
 #    ifdef _MSC_VER
@@ -757,7 +754,6 @@
 #    endif
 #    if __has_feature(cxx_thread_local)
 #      if !defined(__FreeBSD__) /* FreeBSD clang fails on __cxa_thread_atexit */
-#        define Q_COMPILER_THREAD_LOCAL
 #      endif
 #    endif
 #    if __has_feature(cxx_user_literals)
@@ -883,7 +879,6 @@
 #      define Q_COMPILER_ALIGNAS
 #      define Q_COMPILER_ALIGNOF
 #      define Q_COMPILER_INHERITING_CONSTRUCTORS
-#      define Q_COMPILER_THREAD_LOCAL
 #      if Q_CC_GNU > 408 || __GNUC_PATCHLEVEL__ >= 1
 #         define Q_COMPILER_REF_QUALIFIERS
 #      endif
@@ -972,7 +967,6 @@
 #      define Q_COMPILER_NOEXCEPT
 #      define Q_COMPILER_RANGE_FOR
 #      define Q_COMPILER_REF_QUALIFIERS
-#      define Q_COMPILER_THREAD_LOCAL
 // Broken, see QTBUG-47224 and https://connect.microsoft.com/VisualStudio/feedback/details/1549785
 //#      define Q_COMPILER_THREADSAFE_STATICS
 #      define Q_COMPILER_UDL
diff --git a/src/corelib/thread/qthread_unix.cpp b/src/corelib/thread/qthread_unix.cpp
index 69a11b2..534b455 100644
--- a/src/corelib/thread/qthread_unix.cpp
+++ b/src/corelib/thread/qthread_unix.cpp
@@ -114,18 +114,6 @@ Q_STATIC_ASSERT(sizeof(pthread_t) <= sizeof(Qt::HANDLE));
 
 enum { ThreadPriorityResetFlag = 0x80000000 };
 
-#if defined(Q_OS_LINUX) && defined(__GLIBC__) && (defined(Q_CC_GNU) || defined(Q_CC_INTEL)) && !defined(QT_LINUXBASE)
-/* LSB doesn't have __thread, https://lsbbugs.linuxfoundation.org/show_bug.cgi?id=993 */
-#define HAVE_TLS
-#endif
-#if defined(Q_CC_XLC) || defined (Q_CC_SUN)
-#define HAVE_TLS
-#endif
-
-#ifdef HAVE_TLS
-static __thread QThreadData *currentThreadData = 0;
-#endif
-
 static pthread_once_t current_thread_data_once = PTHREAD_ONCE_INIT;
 static pthread_key_t current_thread_data_key;
 
-- 
1.8.3.1

